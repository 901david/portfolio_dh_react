pipeline {
    agent any
    stages {

        stage('Build-Web-Test') {
            steps {
                (
                echo $HEROKU_CREDENTIALS_EMAIL
                echo $HEROKU_CREDENTIALS_PASSWORD
                ) | heroku login

                sh '''
                docker build -t 4990814/test-port-build -f portfolio-client/Dockerfile-dev ./portfolio-client
                '''
            }
        }

        stage('Web-Tests') {
            steps {
                sh 'docker run 4990814/test-port-build npm run test-docker'
            }
        }

        stage('Build-Prod-Web') {
            steps {
                echo 'Building Prod Web Image....'
                sh 'docker build -t registry.heroku.com/portfolio-staged/web -f ./portfolio-client/Dockerfile.webstaged ./portfolio-client'
            }
        }

        stage('Build-Api') {
            steps {
                sh 'docker build -t registry.heroku.com/portfolio-staged/api -f ./portfolio-client/Dockerfile.apistaged ./api'
            }
        }

        stage('Api-Tests') {
            steps {
                echo 'Running API Tests'
            }
        }

        stage('Build-Db-Server') {
            steps {
                sh 'docker build -t registry.heroku.com/portfolio-staged/db -f ./portfolio-client/Dockerfile.dbstaged ./db-server'
            }
        }

        stage('Db-Server-Tests') {
            steps {
                echo 'Running DB-Server Tests'
            }
        }

        stage('Build Router') {
            steps {
                sh 'docker build -t registry.heroku.com/portfolio-staged/router -f ./portfolio-client/Dockerfile.routerstaged ./router'
            }
        }

        stage('Update-Docker-Hub-Images') {
            steps {
                sh
                '''
                (
                echo "$HEROKU_CREDENTIALS_EMAIL"
                echo "$HEROKU_CREDENTIALS_PASSWORD"
                ) | heroku login
                '''
                sh '''
                docker push registry.heroku.com/portfolio-staged/web
                docker push registry.heroku.com/portfolio-staged/api
                docker push registry.heroku.com/portfolio-staged/db
                docker push registry.heroku.com/portfolio-staged/router
                '''
            }
        }
    }
}