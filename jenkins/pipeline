pipeline {
    agent any
    stages {

        stage('Pre-Build') {
            steps{
            echo 'Logging Into Heroku......'
            sh 'heroku container:login'
            }
        }

        stage('Build-Web-Test') {
            steps {
                sh 'docker build -t 4990814/test-port-build -f portfolio-client/Dockerfile-dev ./portfolio-client'
            }
        }

        stage('Web-Tests') {
            steps {
                sh 'docker run 4990814/test-port-build npm run test-docker'
            }
        }

        stage('Build-Prod-Web') {
            steps {
                echo 'Building Prod Web Image....'
                sh 'docker build -t registry.heroku.com/portfolio-staged/client -f ./portfolio-client/Dockerfile.client ./portfolio-client'
            }
        }

        stage('Deploy-Prod-Web') {
            steps {
                echo 'Deploying Prod Web Image....'
                sh '''
                heroku container:push client --app=portfolio-client-staged 
                heroku container:client --app=portfolio-client-staged
                '''
            }
        }

        stage('Build-Api') {
            steps {
                sh 'docker build -t registry.heroku.com/portfolio-staged/api -f ./api/Dockerfile.api ./api'
            }
        }

        stage('Api-Tests') {
            steps {
                echo 'Running API Tests'
            }
        }

        stage('Deploy-API') {
            steps {
                echo 'Deploying Prod Web Image....'
                sh '''
                heroku container:push api --app=portfolio-api-staged 
                heroku container:api --app=portfolio-api-staged
                '''
            }
        }

        stage('Build-Db-Server') {
            steps {
                sh 'docker build -t registry.heroku.com/portfolio-staged/db -f ./db-server/Dockerfile.db ./db-server'
            }
        }

        stage('Db-Server-Tests') {
            steps {
                echo 'Running DB-Server Tests'
            }
        }

        stage('Deploy-Db-Server') {
            steps {
                echo 'Deploying Db Server Image....'
                sh '''
                heroku container:push db --app=portfolio-db-staged 
                heroku container:db --app=portfolio-db-staged
                '''
            }
        }

        stage('Build Router') {
            steps {
                sh 'docker build -t registry.heroku.com/portfolio-staged/router -f ./router/Dockerfile.router ./router'
            }
        }

        stage('Deploy-router') {
            steps {
                echo 'Deploying Router Image....'
                sh '''
                heroku container:push router --app=portfolio-staged 
                heroku container:router --app=portfolio-staged
                '''
            }
        }
    }
}

